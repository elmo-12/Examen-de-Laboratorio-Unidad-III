sequenceDiagram
    autonumber
    actor Usuario as ğŸ‘¤ Usuario/TÃ©cnico
    participant FE as ğŸ–¥ï¸ Frontend<br/>Streamlit
    participant GW as ğŸŒ API Gateway<br/>(Puerto 8000)
    participant MS as ğŸ”§ Mantenimiento<br/>Service
    participant EQ as ğŸ“¦ Equipos<br/>Service
    participant AG as ğŸ¤– Agent<br/>Service
    participant DB as ğŸ—„ï¸ PostgreSQL<br/>Database

    rect rgb(240, 248, 255)
        Note over Usuario,DB: ğŸ“ FASE 1: Registro de Mantenimiento Correctivo
        Usuario->>+FE: Accede a pÃ¡gina de Mantenimiento
        FE->>FE: Carga formulario
        FE->>+GW: GET /api/equipos (lista equipos)
        GW->>+EQ: Solicita lista de equipos
        EQ->>+DB: SELECT * FROM equipos
        DB-->>-EQ: Retorna equipos
        EQ-->>-GW: EnvÃ­a lista de equipos
        GW-->>-FE: Retorna equipos JSON
        FE-->>Usuario: Muestra formulario con equipos
    end

    rect rgb(255, 250, 240)
        Note over Usuario,DB: ğŸ“ FASE 2: Usuario Completa Formulario
        Usuario->>+FE: Selecciona equipo "LAP-2024-001"<br/>Tipo: Correctivo<br/>Problema: Pantalla rota
        Usuario->>FE: Hace clic en "Guardar"
        FE->>FE: Valida datos del formulario
    end

    rect rgb(240, 255, 240)
        Note over Usuario,DB: ğŸ’¾ FASE 3: EnvÃ­o y Procesamiento
        FE->>+GW: POST /api/mantenimientos<br/>{equipo_id, tipo, descripciÃ³n...}
        GW->>GW: Valida autenticaciÃ³n
        GW->>+MS: POST /mantenimientos
        MS->>MS: Valida datos de entrada
        
        MS->>+DB: BEGIN TRANSACTION
        MS->>DB: INSERT INTO mantenimientos
        DB-->>MS: mantenimiento_id = 125
        
        alt Mantenimiento Correctivo
            MS->>DB: UPDATE equipos<br/>SET estado_operativo = 'en_reparacion'<br/>WHERE id = equipo_id
            DB-->>MS: Equipo actualizado
        end
        
        MS->>DB: COMMIT TRANSACTION
        DB-->>-MS: TransacciÃ³n exitosa
        MS-->>-GW: {id: 125, message: "Creado"}
        GW-->>-FE: 200 OK - Mantenimiento registrado
        FE-->>-Usuario: âœ… Muestra mensaje de Ã©xito
    end

    rect rgb(255, 245, 245)
        Note over Usuario,DB: ğŸ¤– FASE 4: Procesamiento AutomÃ¡tico de Agentes
        
        Note right of AG: Agente ejecuta cada 24h<br/>o manualmente
        
        AG->>+DB: SELECT mantenimientos<br/>WHERE fecha_programada IN prÃ³ximos 7 dÃ­as
        DB-->>-AG: Lista de mantenimientos prÃ³ximos
        
        loop Para cada mantenimiento prÃ³ximo
            AG->>AG: Calcula dÃ­as restantes
            AG->>+DB: INSERT INTO notificaciones<br/>{tipo, tÃ­tulo, mensaje...}
            DB-->>-AG: NotificaciÃ³n creada
        end
        
        AG->>+DB: SELECT equipos<br/>WHERE aÃ±os_uso >= vida_Ãºtil
        DB-->>-AG: Equipos obsoletos
        
        loop Para cada equipo obsoleto
            AG->>+DB: INSERT INTO notificaciones<br/>{tipo: 'equipo_obsoleto'...}
            DB-->>-AG: NotificaciÃ³n creada
        end
    end

    rect rgb(248, 240, 255)
        Note over Usuario,DB: ğŸ”” FASE 5: VisualizaciÃ³n de Notificaciones
        Usuario->>+FE: Accede al Dashboard
        FE->>+GW: GET /api/agents/notificaciones
        GW->>+AG: GET /notificaciones?leida=false
        AG->>+DB: SELECT * FROM notificaciones<br/>WHERE leida = false
        DB-->>-AG: Lista de notificaciones (10)
        AG-->>-GW: Retorna notificaciones
        GW-->>-FE: JSON con notificaciones
        FE-->>-Usuario: ğŸ”” Muestra 10 notificaciones<br/>en sidebar
    end

    rect rgb(255, 255, 240)
        Note over Usuario,DB: ğŸ“Š FASE 6: GeneraciÃ³n de Reportes
        Usuario->>+FE: Solicita reporte de costos
        FE->>+GW: GET /api/reportes/costos-mantenimiento
        GW->>+MS: GET /estadisticas
        MS->>+DB: SELECT tipo, SUM(costo)<br/>FROM mantenimientos<br/>GROUP BY tipo
        DB-->>-MS: EstadÃ­sticas de costos
        MS-->>-GW: JSON con datos
        GW-->>-FE: Datos de costos
        FE->>FE: Genera grÃ¡ficos con Plotly
        FE-->>-Usuario: ğŸ“Š Muestra dashboard<br/>con grÃ¡ficos interactivos
    end

    Note over Usuario,DB: âœ… Proceso Completado Exitosamente